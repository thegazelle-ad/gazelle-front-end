machine:
  # Setup known_hosts so the VM allows ssh access without the prompt
  post:
    - echo '|1|lngQecMeLZI49/+fr5Ee0gOWaKE=|arylHILm4qsNJewDKKwFKOijBxE= ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBLONO0airQQL9d1rOZzT/p3SBH8acSYaN4N8qJezd/0UbnF8SBi+m1wB2nay5o0HQBQTM6O+MKXDwzYec886K78=' >> ~/.ssh/known_hosts

dependencies:
  override:
    - npm install
  # Set CIRCLECI environment variable so getGhostConfig knows there's no database
  environment:
    CIRCLECI: true
  post:
    - cp config/database.config.example.js config/database.config.js
    - cp config/s3.config.example.js config/s3.config.js
    - cp config/ghost.config.example.js config/ghost.config.js
    - ./scripts/get-ghost-config.sh

compile:
  override:
    - npm run build-production

test:
  override:
    - npm test
    - npm run lint

deployment:
  beta:
    branch: master
    commands:
      - ssh gazelle@51.15.130.216 ./deployment/update-beta.sh
  production:
    branch: stable
    commands:
      - ssh gazelle@51.15.130.216 ./deployment/update-production.sh
